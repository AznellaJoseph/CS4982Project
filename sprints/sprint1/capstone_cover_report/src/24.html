<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>/home/alexthemathnerd/Code/Capstone/code/CapstoneBackend/DAL/UserDAL.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Data;
using CapstoneBackend.Model;
using CapstoneBackend.Utils;
using MySql.Data.MySqlClient;

namespace CapstoneBackend.DAL
{
    /// &lt;summary&gt;
    ///     Data Access Layer (DAL) for User
    /// &lt;/summary&gt;
    public class UserDal
    {
        private readonly MySqlConnection _connection;

        public UserDal() : this(new MySqlConnection(Connection.ConnectionString))
        {
        }

        public UserDal(MySqlConnection connection)
        {
            _connection = connection;

        }

        /// &lt;summary&gt;
        ///     Gets the user with the specified username
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;username&quot;&gt;The username.&lt;/param&gt;
        /// &lt;returns&gt; The user with the given username&lt;/returns&gt;
        public virtual User? GetUserByUsername(string username)
        {
            this._connection.Open();
            const string query = &quot;uspGetUserByUsername&quot;;
            using MySqlCommand cmd = new(query, _connection);
            cmd.CommandType = CommandType.StoredProcedure;
            cmd.Parameters.Add(&quot;@username&quot;, MySqlDbType.VarChar).Value = username;

            using var reader = cmd.ExecuteReaderAsync().Result;
            var idOrdinal = reader.GetOrdinal(&quot;id&quot;);
            var fnameOrdinal = reader.GetOrdinal(&quot;fname&quot;);
            var lnameOrdinal = reader.GetOrdinal(&quot;lname&quot;);
            var passwordOrdinal = reader.GetOrdinal(&quot;password&quot;);

            User? user = null;
            
            if (reader.Read())
            {
                user = new User
                  {
                      Id = reader.GetInt32(idOrdinal),
                      Username = username, 
                      FirstName = reader.GetString(fnameOrdinal),
                      LastName = reader.GetString(lnameOrdinal),
                      Password = reader.GetString(passwordOrdinal)
                  };
            }
              
            this._connection.Close();
            return user;
        }

        /// &lt;summary&gt;Inserts a User into the DB.&lt;/summary&gt;
        /// &lt;param name=&quot;username&quot;&gt;The username.&lt;/param&gt;
        /// &lt;param name=&quot;password&quot;&gt;The password.&lt;/param&gt;
        /// &lt;param name=&quot;fname&quot;&gt;The first name.&lt;/param&gt;
        /// &lt;param name=&quot;lname&quot;&gt;The last name.&lt;/param&gt;
        /// &lt;returns&gt;ID of new user if successful. null, otherwise.&lt;/returns&gt;
        public virtual int? CreateUser(string username, string password, string fname, string lname)
        {
            this._connection.Open();
            const string procedure = &quot;uspCreateUser&quot;;
            using MySqlCommand cmd = new(procedure, _connection);
            cmd.CommandType = CommandType.StoredProcedure;

            cmd.Parameters.Add(&quot;@username&quot;, MySqlDbType.VarChar).Value = username;
            cmd.Parameters.Add(&quot;@password&quot;, MySqlDbType.VarChar).Value = PasswordHasher.Hash(password);
            cmd.Parameters.Add(&quot;@fname&quot;, MySqlDbType.VarChar).Value = fname;
            cmd.Parameters.Add(&quot;@lname&quot;, MySqlDbType.VarChar).Value = lname;
            cmd.Parameters.Add(&quot;@userId&quot;, MySqlDbType.Int32).Direction = ParameterDirection.Output;

            try
            {
                cmd.ExecuteNonQuery();
                var userId = cmd.Parameters[&quot;@userId&quot;].Value;
                this._connection.Close();
                return Convert.ToInt32(userId);
            }
            catch
            {
                this._connection.Close();
                return null;
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[16,28,16,82,1],[17,9,17,10,1],[18,9,18,10,1],[20,9,20,51,1],[21,9,21,10,1],[22,13,22,38,1],[24,9,24,10,1],[32,9,32,10,0],[33,13,33,37,0],[35,13,35,62,0],[36,13,36,59,0],[37,13,37,83,0],[39,13,39,64,0],[40,13,40,53,0],[41,13,41,59,0],[42,13,42,59,0],[43,13,43,65,0],[45,13,45,31,0],[47,13,47,31,0],[48,13,48,14,0],[49,17,56,21,0],[57,13,57,14,0],[59,13,59,38,0],[60,13,60,25,0],[61,9,61,10,0],[70,9,70,10,0],[71,13,71,37,0],[73,13,73,66,0],[74,13,74,59,0],[76,13,76,83,0],[77,13,77,104,0],[78,13,78,77,0],[79,13,79,77,0],[80,13,80,100,0],[83,13,83,14,0],[84,17,84,39,0],[85,17,85,62,0],[86,17,86,42,0],[87,17,87,48,0],[89,13,89,18,0],[90,13,90,14,0],[91,17,91,42,0],[92,17,92,29,0],[94,9,94,10,0]]);
    </script>
  </body>
</html>